FROM elixir:1.17-slim AS build
ENV MIX_ENV=prod

RUN apt-get update && \
  apt-get install -y build-essential git curl npm && \
  rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY mix.exs mix.lock ./
RUN mix local.hex --force && mix local.rebar --force
RUN mix deps.get --only prod
RUN mix deps.compile

COPY . .
RUN mix compile
RUN mix release --overwrite

FROM debian:bookworm-slim AS runner

RUN apt-get update && \
  apt-get install -y openssl ncurses-bin libssl3 locales netcat-openbsd && \
  echo "en_US.UTF-8 UTF-8" > /etc/locale.gen && locale-gen en_US.UTF-8 && \
  rm -rf /var/lib/apt/lists/*

ENV LANG=en_US.UTF-8
ENV LANGUAGE=en_US:en
ENV LC_ALL=en_US.UTF-8
ENV MIX_ENV=prod
ENV HOME=/app

WORKDIR /app

COPY --from=build /app/_build/prod/rel/backend ./

COPY entrypoint.sh /app/entrypoint.sh
RUN chmod +x /app/entrypoint.sh

EXPOSE 4117

ENTRYPOINT ["/app/entrypoint.sh"]
CMD ["bin/backend", "start"]
